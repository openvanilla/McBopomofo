# AGENTS.md

This file provides guidance to AI coding assistants when working with dictionary data in this directory.

## Overview

The `Source/Data/` directory contains all dictionary data files and the build system for generating McBopomofo's language model data. These files define the mapping between Bopomofo phonetic input and Traditional Chinese characters/phrases, along with frequency data and special features like macros and symbols.

**For comprehensive dictionary development workflows**, see [Wiki: 詞庫開發說明](https://github.com/openvanilla/McBopomofo/wiki/詞庫開發說明). This document provides technical reference for AI assistants.

**GitHub Copilot users:** See `.github/instructions/Data.instructions.md` for path-specific Copilot instructions for this directory.

**General guidelines** (emoji, date/time format, Conventional Commits, etc.) are defined in the root `AGENTS.md` and `.github/copilot-instructions.md`.

**Key Principles:**
- In most cases, you'll be **adding** new characters or phrases rather than deleting existing ones

## File Descriptions

### Source Data Files (Input)

| File | Purpose | Format |
|------|---------|--------|
| `BPMFBase.txt` | Single character Bopomofo mappings | `character bopomofo pinyin tone tag` |
| `BPMFMappings.txt` | Multi-character phrases (2-6 chars) | `phrase bpmf1 bpmf2 ...` (space-separated) |
| `BPMFPunctuations.txt` | Punctuation marks mapping | Similar to BPMFBase |
| `phrase.occ` | Phrase frequency/occurrence data | `phrase frequency` (tab-separated) |
| `heterophony1.list` | Primary heterophony readings | `character bopomofo` |
| `heterophony2.list` | Secondary heterophony readings | `character bopomofo` |
| `heterophony3.list` | Tertiary heterophony readings | `character bopomofo` |
| `exclusion.txt` | Phrase frequency exclusions | `phrase context_to_exclude` (tab-separated) |
| `Symbols.txt` | Special symbols (era names, etc.) | `symbol bopomofo score` |
| `Macros.txt` | Text macros (date/time) | `MACRO@NAME bopomofo score` |
| `associated-punctuation.txt` | Punctuation for phrase associations | Special format for derive script |

### Generated Output Files

| File | Generated By | Purpose |
|------|--------------|---------|
| `data.txt` | `make all` | Main language model data for McBopomofo |
| `data-plain-bpmf.txt` | `make all` | Data for traditional Bopomofo IME mode |
| `associated-phrases-v2.txt` | `make all` | Associated phrase suggestions |
| `PhraseFreq.txt` | `make all` | Compiled frequency data |

**Important:** Generated output files are built locally and NOT committed to git (listed in `.gitignore`).

## Common Commands

```bash
# Essential Make Targets
make all           # Generate all output files
make sort          # Sort all data files with correct C locale
make check         # Validate data integrity
make tidy          # Clean up formatting issues
make clean         # Clean generated files

# Recommended workflow: format, sort, validate, and build
make tidy sort check all
```

### Building via Xcode

```bash
xcodebuild -project ../McBopomofo.xcodeproj -target Data -configuration Debug build
# Or select "Data" scheme in Xcode and build (⌘+B)
```

This runs `make all` as part of the Xcode build process. For dictionary development, using `make` directly is recommended.

### Critical: C Locale Sorting

**All data files MUST be sorted with C locale** for binary search compatibility:

```bash
# Primary data files
LC_ALL=C sort -o BPMFMappings.txt BPMFMappings.txt
LC_ALL=C sort -o phrase.occ phrase.occ

# Heterophony lists
env LANG=C sort -k1 heterophony1.list | uniq > tmp && mv tmp heterophony1.list
env LANG=C sort -k1 heterophony2.list | uniq > tmp && mv tmp heterophony2.list
env LANG=C sort -k1 heterophony3.list | uniq > tmp && mv tmp heterophony3.list
```

## Workflow: Adding/Modifying Phrases

### Adding a New Multi-Character Phrase

1. **Add to BPMFMappings.txt:**
   ```
   新詞彙 ㄒㄧㄣ ㄘˊ ㄏㄨㄟˋ
   ```
   Format: phrase, then Bopomofo for each character (space-separated)

2. **Add to phrase.occ with frequency:**
   ```
   新詞彙	100
   ```
   - Frequency must be a positive integer (0 is acceptable, negative values are NOT)
   - Use tab separator between phrase and frequency
   - Higher frequency = more common phrase

3. **Sort both files:**
   ```bash
   make sort
   # Or manually:
   LC_ALL=C sort -o BPMFMappings.txt BPMFMappings.txt
   LC_ALL=C sort -o phrase.occ phrase.occ
   ```

4. **Validate and build:**
   ```bash
   make check    # Validate integrity
   make all      # Generate output files
   ```

### Adding a Single Character

Single characters go into `BPMFBase.txt`:

```
字 ㄗˋ zi4 -4 big5
```

Format: `character bopomofo pinyin tone tag`

### Handling Heterophony Characters (破音字)

For characters with multiple pronunciations (e.g., 行: ㄏㄤˊ vs ㄒㄧㄥˊ):

1. Place most common reading in `heterophony1.list`, less common in `heterophony2.list`, rare in `heterophony3.list`
2. Add both readings to `BPMFMappings.txt`

Example:
```bash
# heterophony1.list
行 ㄏㄤˊ

# heterophony2.list
行 ㄒㄧㄥˊ
```

### Adding Emojis and Symbols

Emojis/symbols are allowed but **MUST NOT be the default candidate**. Add to `Symbols.txt` with negative score (e.g., `-8`).

## File Format Specifications

| File | Format | Rules | Example |
|------|--------|-------|---------|
| **BPMFMappings.txt** | `phrase bpmf1 bpmf2 ...` | Space-separated; character count = Bopomofo count; C locale sorted | `小麥注音 ㄒㄧㄠˇ ㄇㄞˋ ㄓㄨˋ ㄧㄣ` |
| **phrase.occ** | `phrase<TAB>frequency` | Tab-separated; frequency ≥ 0 (no negatives); C locale sorted | `小麥<TAB>120` |
| **heterophony*.list** | `character bopomofo` | One reading per line; sorted by character | `中 ㄓㄨㄥ` |
| **exclusion.txt** | `phrase<TAB>context` | Tab-separated; excludes phrase when in context | `一下<TAB>國一下` |
| **Symbols.txt** | `symbol bopomofo score` | Space-separated; negative score for low priority | `平成 ㄆㄧㄥˊ-ㄔㄥˊ -8` |
| **Macros.txt** | `MACRO@NAME bopomofo score` | Space-separated; runtime expansion | `MACRO@DATE_TODAY ㄐㄧㄣ-ㄊㄧㄢ -8` |

**Critical Format Rules:**
- BPMFMappings.txt and phrase.occ use **different separators** (space vs tab)
- Character count in phrase must equal number of Bopomofo readings
- Frequencies must be non-negative integers (0 acceptable, negatives NOT allowed)
- All files must be C locale sorted for binary search compatibility

## Python Tools in bin/

| Script | Purpose |
|--------|---------|
| `cook.py` | Main build script: combines all source files into `data.txt` |
| `cook-plain-bpmf.py` | Builds `data-plain-bpmf.txt` for traditional Bopomofo mode |
| `buildFreq.py` | Generates `PhraseFreq.txt` from `phrase.occ` and `exclusion.txt` |
| `derive_associated_phrases.py` | Generates associated phrase suggestions from `data.txt` |
| `bpmfmap.py` | Helper for automatic Bopomofo mapping |
| `count.occurrence.py` | Counts phrase occurrences in text corpus |
| `self-score-test.py` | Validates and scores dictionary data quality |
| `nonCJK_filter.py` | Filters out non-CJK characters |
| `audit_encoding.swift` | Checks file encoding issues |


## Data Generation Pipeline

The build process flows: `phrase.occ` + `exclusion.txt` → `buildFreq.py` → `PhraseFreq.txt` → `cook.py` (+ other inputs) → `data.txt` → `derive_associated_phrases.py` → `associated-phrases-v2.txt`.

For detailed pipeline diagram, frequency calculation algorithms, and heterophony processing logic, see `algorithm.md` section "字典資料的生成與使用".

## Editorial Guidelines

For editorial policies, see [Wiki: 詞庫開發說明](https://github.com/openvanilla/McBopomofo/wiki/詞庫開發說明).

### Phrase Quality Control

Check phrase rarity: `site:.tw "phrase"` (under 1,000 results → likely safe to remove)

### Data Integrity Checks

```bash
# Character count matches Bopomofo count (empty output = good)
awk 'length($1)/3!=NF-1' BPMFMappings.txt

# Phrase consistency check
diff -u <(awk '{print $1}' BPMFMappings.txt|sort -u) \
        <(awk 'length($1)>3{print $1}' phrase.occ|sort -u)
```

## Testing Your Changes

```bash
make tidy sort    # Format and sort
make check        # Validate integrity
make all          # Build output files
make _install     # Install to ~/Library/Input Methods/McBopomofo.app/
pkill -HUP McBopomofo  # Restart
```

## Common Issues and Solutions

| Issue | Solution |
|-------|----------|
| Sort order is wrong | Always use C locale: `LC_ALL=C sort -o file file` |
| Phrase in BPMFMappings.txt not showing | Verify phrase exists in `phrase.occ` with non-zero frequency |
| make check fails (character count) | Ensure character count = Bopomofo reading count |
| Heterophony shows wrong default | Place common reading in `heterophony1.list`, less common in `heterophony2.list` |
| Emoji appears as first candidate | Add to `Symbols.txt` with negative score (e.g., -8) |

## Reference Files for Context

- Root `AGENTS.md`: Overall project architecture and build system
- `algorithm.md`: Detailed algorithm explanation (Chinese)
- [Wiki: 程式架構](https://github.com/openvanilla/McBopomofo/wiki/程式架構): Program architecture
- [Wiki: 詞庫開發說明](https://github.com/openvanilla/McBopomofo/wiki/詞庫開發說明): Dictionary development guide
- [Wiki: 使用手冊](https://github.com/openvanilla/McBopomofo/wiki/使用手冊): User manual
